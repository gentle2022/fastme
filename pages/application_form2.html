<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sponsorship Application - Step 2 - SoftGap</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <style>
    body { background: linear-gradient(135deg, #f0f4f8, #ffffff); font-family: 'Montserrat', Arial, sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
    .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); position: sticky; top: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
    .navbar-brand { color: #111 !important; font-weight: 700; }
    .navbar-brand:hover { color: #1766d9 !important; }
    .navbar-nav .nav-link { color: #111 !important; transition: color 0.3s; }
    .navbar-nav .nav-link:hover { color: #1766d9 !important; }
    .form-section-container { max-width: 900px; margin: 20px auto; background: #ffffff; border-radius: 20px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); padding: 30px; flex: 1; display: flex; flex-direction: column; }
    .progress-container { margin-bottom: 20px; }
    .progress { height: 8px; border-radius: 4px; background: #e9ecef; }
    .progress-bar { background: #1766d9; transition: width 0.3s ease-in-out; }
    .form-title { text-align: center; font-weight: 800; font-size: 2.2rem; margin-bottom: 20px; color: #222; letter-spacing: 1px; }
    .form-label { font-weight: 600; color: #333; margin-bottom: 6px; }
    .form-control, .form-select { border: 1px solid #ced4da; border-radius: 10px; min-height: 42px; padding: 10px 12px; transition: border-color 0.3s, box-shadow 0.3s; }
    .form-control:focus, .form-select:focus { border-color: #1766d9; box-shadow: 0 0 5px rgba(23, 102, 217, 0.3); outline: none; }
    .btn-primary { background: #1766d9; color: #fff; font-weight: 700; border-radius: 10px; padding: 10px 20px; border: none; transition: background 0.3s, transform 0.2s; }
    .btn-primary:hover { background: #1352ad; transform: translateY(-2px); }
    .footer-nav { margin-top: auto; padding: 15px 0; background: #f8f9fa; text-align: center; border-top: 1px solid #eee; font-size: 0.85rem; color: #555; }
    .footer-nav a { color: #1766d9; text-decoration: none; margin: 0 5px; }
    .footer-nav a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
          <img src="pages/stylish/images/logo2.jpg" alt="SoftGap Logo" style="width: 40px; height: 40px;">
          <span class="fw-bold">SoftGap<br><small>Systems Limited</small></span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="mainNav">
          <ul class="navbar-nav mb-2 mb-lg-0 gap-lg-5">
            <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="pages/services.html">Services</a></li>
            <li class="nav-item"><a class="nav-link" href="pages/contact.html">Contact Us</a></li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <div class="form-section-container">
    <div class="progress-container">
      <div class="progress-step form-step">Step 2 of 4</div>
      <div class="progress">
        <div class="progress-bar" role="progressbar" style="width: 50%;" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
    </div>
    <div class="form-title">VISA / INTERNATIONAL SPONSORSHIP INFORMATION</div>
    <div id="userInfo" class="mb-4"></div>

    <form id="sponsorshipForm" style="display: none;">
      <div class="row g-3">
        <div class="col-md-6">
          <label for="occupation" class="form-label">Occupation/Profession</label>
          <input type="text" class="form-control" id="occupation" placeholder="e.g., Software Engineer" required>
        </div>
        <div class="col-md-6">
          <label for="employerOrSchool" class="form-label">Employer/School Name</label>
          <input type="text" class="form-control" id="employerOrSchool" placeholder="Enter employer or school name" required>
        </div>
        <div class="col-md-6">
          <label for="country" class="form-label">Country of Residence</label>
          <input type="text" class="form-control" id="country" placeholder="e.g., Canada" required>
        </div>
        <div class="col-md-6">
          <label for="province" class="form-label">Province/State/Region</label>
          <input type="text" class="form-control" id="province" placeholder="e.g., Ontario" required>
        </div>
        <div class="col-md-6">
          <label for="passportType" class="form-label">International ID Type</label>
          <select class="form-select" id="passportType" required>
            <option value="">Select ID Type</option>
            <option>Passport</option>
            <option>National ID Card</option>
            <option>Voter's Card</option>
            <option>Driver's License</option>
            <option>Student ID</option>
            <option>Residence Permit</option>
            <option>Social Security Card</option>
            <option>Other</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="passportNumber" class="form-label">Passport/ID Number</label>
          <input type="text" class="form-control" id="passportNumber" placeholder="Enter Passport or ID Number" required>
        </div>
        <div class="col-md-6">
          <label for="travelPurpose" class="form-label">Purpose of Visit</label>
          <select class="form-select" id="travelPurpose" required>
            <option value="">Select purpose</option>
            <option>Work</option>
            <option>Study</option>
            <option>Family Reunification</option>
            <option>Conference</option>
            <option>Research</option>
            <option>Medical</option>
            <option>Tourism</option>
            <option>Other</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="destinationCountry" class="form-label">Destination Country</label>
          <input type="text" class="form-control" id="destinationCountry" placeholder="e.g., United Kingdom" required>
        </div>
        <div class="col-md-6">
          <label for="sponsorshipType" class="form-label">Available Sponsorship</label>
          <select class="form-select" id="sponsorshipType" required>
            <option value="">Select a sponsorship</option>
            <option value="driver">Driver - Switzerland, UK, US, Canada (Visa sponsorship + relocation)</option>
            <option value="developer">Full Stack Developer - Canada, USA, Hong Kong (Remote + relocation)</option>
            <option value="family">Family Location (Visa + housing fee 60% covered)</option>
            <option value="nurse">Nurse - UK, US, Canada (Visa sponsorship + relocation)</option>
            <option value="mechanic">Auto Mechanic - London, UK (Relocation sponsorship)</option>
            <option value="caregiver">Caregiver - USA (Visa + housing fully covered)</option>
            <option value="canada_scholarship">2025 Canada Graduate Scholarship (Full tuition + visa & accommodation)</option>
            <option value="uk_masters">UK Masters Scholarship (Partial sponsorship & monthly stipend)</option>
            <option value="eu_phd">EU Research Grant for PhD Students (Fully funded research)</option>
            <option value="adb_asia">Asian Development Bank Scholarship (Asia/Pacific)</option>
            <option value="diplomat">Best Diplomats - Global Youth Diplomat (USA, Dubai, Malaysia: 60% costs covered)</option>
            <option value="conference">Conference Sponsorship (Europe, Canada, UAE; ticket, visa, accommodation)</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="intendedArrival" class="form-label">Intended Date of Arrival</label>
          <input type="date" class="form-control" id="intendedArrival" required>
        </div>
        <div class="col-md-6">
          <label for="durationOfStay" class="form-label">Intended Duration of Stay (in months)</label>
          <input type="number" min="1" class="form-control" id="durationOfStay" placeholder="e.g., 12" required>
        </div>
        <div class="col-md-12">
          <label for="previousTravel" class="form-label">Previous International Travel (Countries visited and year, if any)</label>
          <input type="text" class="form-control" id="previousTravel" placeholder="e.g., USA 2023; UK 2022">
        </div>
        <div class="col-md-12">
          <label for="additionalNotes" class="form-label">Additional Notes (Optional)</label>
          <textarea class="form-control" id="additionalNotes" rows="2" placeholder="Any extra information"></textarea>
        </div>
      </div>
      <div class="text-center mt-4">
        <button type="button" class="btn btn-primary px-5 fw-bold" id="nextBtn">Next</button>
      </div>
      <div id="formMsg" class="mt-3"></div>
    </form>

    <div id="notLoggedIn" class="alert alert-warning" style="display:none;">
      You must <a href="index.html">login or signup</a> to apply for a sponsorship.
    </div>
  </div>

  <div class="footer-nav">
    Need help? <a href="pages/contact.html">Contact Support</a> | <a href="index.html">Back to Home</a>
  </div>

  <script>
   const firebaseConfig = {
    apiKey: "AIzaSyDO5Bpeg0Ewg6lUzbIaI-Kp4wC9ET6OQfE",
    authDomain: "visasponsor-e62c2.firebaseapp.com",
    projectId: "visasponsor-e62c2",
    storageBucket: "visasponsor-e62c2.firebasestorage.app",
    messagingSenderId: "179101134570",
    appId: "1:179101134570:web:bea801f12c1a620717b193",
    measurementId: "G-NE7T0PPG6K"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(async user => {
      if (!user) {
        document.getElementById('sponsorshipForm').style.display = 'none';
        document.getElementById('notLoggedIn').style.display = 'block';
        setTimeout(() => window.location.href = "index.html", 2000);
      } else {
        const docRef = db.collection('loanApplications').doc(user.uid);
        const doc = await docRef.get();

        if (!doc.exists || !doc.data().progress || doc.data().progress < 2) {
          window.location.href = "application_form.html"; 
          return;
        }

        const data = doc.data();
        if (data.progress === 3) {
          window.location.href = "eligibility.html";
          return;
        } else if (data.progress === 4) {
          window.location.href = "dashboard.html";
          return;
        }

        // Prefill if exists
        document.getElementById('occupation').value = data.occupation || '';
        document.getElementById('employerOrSchool').value = data.employerOrSchool || '';
        document.getElementById('country').value = data.country || '';
        document.getElementById('province').value = data.province || '';
        document.getElementById('passportType').value = data.passportType || '';
        document.getElementById('passportNumber').value = data.passportNumber || '';
        document.getElementById('travelPurpose').value = data.travelPurpose || '';
        document.getElementById('destinationCountry').value = data.destinationCountry || '';
        document.getElementById('sponsorshipType').value = data.sponsorshipType || '';
        document.getElementById('intendedArrival').value = data.intendedArrival || '';
        document.getElementById('durationOfStay').value = data.durationOfStay || '';
        document.getElementById('previousTravel').value = data.previousTravel || '';
        document.getElementById('additionalNotes').value = data.additionalNotes || '';

        document.getElementById('sponsorshipForm').style.display = 'block';
        document.getElementById('notLoggedIn').style.display = 'none';
        document.getElementById('userInfo').innerHTML = `
          <strong>Logged in as:</strong> ${user.displayName || ""} (${user.email})
          <button class="btn btn-link p-0 ms-2" id="logoutBtn">Logout</button>
        `;
        document.getElementById('logoutBtn').onclick = function() {
          auth.signOut().then(() => window.location.reload());
        };
      }
    });

    document.getElementById('nextBtn').addEventListener('click', async function() {
      const form = document.getElementById('sponsorshipForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const formData = {
        occupation: document.getElementById('occupation').value.trim(),
        employerOrSchool: document.getElementById('employerOrSchool').value.trim(),
        country: document.getElementById('country').value.trim(),
        province: document.getElementById('province').value.trim(),
        passportType: document.getElementById('passportType').value,
        passportNumber: document.getElementById('passportNumber').value.trim(),
        travelPurpose: document.getElementById('travelPurpose').value,
        destinationCountry: document.getElementById('destinationCountry').value.trim(),
        sponsorshipType: document.getElementById('sponsorshipType').value,
        intendedArrival: document.getElementById('intendedArrival').value,
        durationOfStay: document.getElementById('durationOfStay').value,
        previousTravel: document.getElementById('previousTravel').value.trim(),
        additionalNotes: document.getElementById('additionalNotes').value.trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      const user = auth.currentUser;
      if (user) {
        try {
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.disabled = true;
            nextBtn.innerHTML = "Processing and Saving...";
            
            await db.collection('loanApplications').doc(user.uid).update(formData);
            await db.collection('loanApplications').doc(user.uid).update({ progress: 3 });

            window.location.href = 'eligibility.html';

        } catch (error) {
            document.getElementById('formMsg').innerHTML = `<span class="text-danger">Error saving data: ${error.message}</span>`;
            nextBtn.disabled = false;
            nextBtn.innerHTML = "Next";
        }
      } else {
        document.getElementById('formMsg').innerHTML = '<span class="text-danger">You must be logged in to submit the form.</span>';
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>